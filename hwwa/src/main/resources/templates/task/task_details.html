<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Task Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/main.css}">
  <link rel="stylesheet" th:href="@{/css/table.css}">
  <link rel="stylesheet" th:href="@{/css/input_fields_and_icons.css}">
  <link rel="stylesheet" th:href="@{/css/cards.css}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="d-flex flex-column min-vh-100 bg-body">
<div th:insert="~{fragments/header :: siteHeader}"></div>

<main class="flex-grow-1">
  <div class="container-xxl py-4">

    <div class="d-flex justify-content-between align-items-start gap-3 mb-4">
      <div>
        <h1 class="mb-1" th:text="${task.title}">Task Title</h1>
        <p class="text-muted mb-0">
          ID: <span th:text="${task.id}">1</span>
          <span class="mx-2">•</span>
          Status:
          <span class="badge text-bg-secondary"
                th:text="${task.status != null ? task.status : '-'}">PLANNED</span>
        </p>

        <div class="mt-2">
          <small class="text-muted"
                 th:if="${task.startDateTime != null and task.endDateTime != null}"
                 th:text="${#temporals.format(task.startDateTime, 'dd.MM.yyyy HH:mm') + ' - ' + #temporals.format(task.endDateTime, 'dd.MM.yyyy HH:mm')}">
          </small>
          <small class="text-muted" th:if="${task.startDateTime == null or task.endDateTime == null}">
            Kein Zeitraum gesetzt.
          </small>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 justify-content-end">
        <a th:href="@{/tasks}" class="btn btn-outline-secondary">Zurück</a>

        <form th:if="${canManageTasks}" th:action="@{/tasks/{id}/delete(id=${task.id})}" method="post">
          <button type="submit" class="btn btn-outline-danger"
                  onclick="return confirm('Task wirklich löschen?');">
            Löschen
          </button>
        </form>

        <a th:href="@{/tasks/{id}/pdf(id=${task.id})}" class="btn btn-outline-secondary">PDF</a>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">

        <div class="card shadow-sm mb-4">
          <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
            <strong>Beschreibung</strong>
            <small class="text-muted" th:if="${!canManageTasks}">Nur Ansicht</small>
          </div>

          <div class="card-body">
            <p class="mb-3" th:text="${task.description}">Beschreibung...</p>

            <div th:if="${canManageTasks}">
              <hr>
              <h5 class="mb-3">Task bearbeiten</h5>

              <form th:object="${taskUpdate}" th:action="@{/tasks/{id}/edit(id=${task.id})}" method="post">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Titel</label>
                    <input class="form-control"
                           th:field="*{title}"
                           th:classappend="${#fields.hasErrors('title')} ? 'is-invalid'">
                    <div class="invalid-feedback" th:errors="*{title}"></div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Status</label>
                    <select class="form-select"
                            th:field="*{status}"
                            th:classappend="${#fields.hasErrors('status')} ? 'is-invalid'">
                      <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
                    </select>
                    <div class="invalid-feedback" th:errors="*{status}"></div>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-control" rows="4"
                              th:field="*{description}"
                              th:classappend="${#fields.hasErrors('description')} ? 'is-invalid'"></textarea>
                    <div class="invalid-feedback" th:errors="*{description}"></div>
                  </div>

                  <div class="col-md-8">
                    <label class="form-label">Kunde</label>
                    <select class="form-select"
                            th:field="*{clientId}"
                            th:classappend="${#fields.hasErrors('clientId')} ? 'is-invalid'">
                      <option value="" disabled>Bitte wählen...</option>
                      <option th:each="c : ${clients}" th:value="${c.id}" th:text="${c.name}"></option>
                    </select>
                    <div class="invalid-feedback" th:errors="*{clientId}"></div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Start</label>
                    <input type="datetime-local" class="form-control" th:field="*{startDateTime}">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Ende</label>
                    <input type="datetime-local" class="form-control" th:field="*{endDateTime}">
                  </div>
                </div>

                <div class="mt-3">
                  <button type="submit" class="btn btn-primary">Änderungen speichern</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
            <strong>Ort / Karte</strong>
          </div>

          <div class="card-body">
            <div id="map"
                 class="border rounded"
                 style="height: 240px;">
            </div>
          </div>
        </div>

        <script th:inline="javascript">
          const taskId = [[${task.id}]];

          fetch(`/tasks/${taskId}/location`)
                  .then(r => r.json())
                  .then(data => {
                    const map = L.map('map').setView([data.latitude, data.longitude], 14);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
                            .addTo(map);

                    L.marker([data.latitude, data.longitude]).addTo(map);
                  })
                  .catch(() => {
                    document.getElementById('map').innerHTML =
                            '<div class="text-muted text-center p-4">Kein Standort verfügbar</div>';
                  });
        </script>

        <div class="card shadow-sm mb-4">
          <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
            <strong><span th:text="#{weather_header}"></span></strong>
          </div>

          <div class="card-body">
            <div class="bg-body-tertiary border rounded p-4" style="min-height: 200px;">
              <div class="d-flex justify-content-between align-items-start gap-3">
                <div>
                  <div class="fw-semibold" th:text="#{weather_data}"></div>
                </div>
                <span class="badge text-bg-secondary" th:text="#{weather_current}"></span>
              </div>

              <hr class="my-3">

              <div class="row g-3">
                <div class="col-md-4">
                  <div class="text-muted small mb-1" th:text="#{location}"></div>
                  <div th:text="${weather.city}"></div>
                </div>
                <div class="col-md-4">
                  <div class="text-muted small mb-1" th:text="#{temperature}"></div>
                  <div><span th:text="${weather.temperature}"></span> °C</div>
                </div>
                <div class="col-md-4">
                  <div class="text-muted small mb-1" th:text="#{wind_speed}"></div>
                  <div><span th:text="${weather.windSpeed}"></span> m/s</div>
                </div>
                <div class="col-12">
                  <div class="text-muted small mb-1" th:text="#{weather}"></div>
                  <div th:text="${weather.description}"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
            <strong>Materialien</strong>
            <a th:href="@{/tasks/{taskId}/materials/add(taskId=${task.id})}"
               class="btn btn-sm btn-outline-primary">
              + Material
            </a>
          </div>

          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead class="bg-body-tertiary">
              <tr>
                <th>Name</th>
                <th style="width: 140px;">Menge</th>
                <th style="width: 160px;">Preis/Einheit</th>
                <th style="width: 120px;" class="text-end">Aktionen</th>
              </tr>
              </thead>

              <tbody>
              <tr th:if="${materials == null or materials.isEmpty()}">
                <td colspan="4" class="text-muted">Keine Materialien erfasst.</td>
              </tr>

              <tr th:each="m : ${materials}">
                <td th:text="${m.description}">Kabel</td>
                <td th:text="${m.quantity}">1.000</td>
                <td th:text="${m.unitPrice}">10.00</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary"
                     th:href="@{/tasks/{taskId}/materials/{id}(taskId=${task.id}, id=${m.id})}">
                    Details
                  </a>
                </td>
              </tr>
              </tbody>

            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">

        <div class="card shadow-sm mb-4">
          <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
            <strong>ToDos</strong>
            <a th:href="@{/tasks/{taskId}/todos/add(taskId=${task.id})}"
               class="btn btn-sm btn-outline-primary">
              + Todo
            </a>
          </div>

          <div class="card-body">
            <div th:if="${todos == null or todos.isEmpty()}" class="text-muted">
              Keine ToDos vorhanden.
            </div>

            <div th:if="${todos != null and !todos.isEmpty()}" class="vstack gap-2">
              <div th:each="t : ${todos}" class="d-flex align-items-start gap-2">
                <form th:action="@{/tasks/{taskId}/todos/{id}/toggle(taskId=${task.id}, id=${t.id})}"
                      method="post">
                  <input type="checkbox"
                         th:checked="${t.done}"
                         onchange="this.form.submit()">
                </form>

                <div class="flex-grow-1">
                  <a class="text-decoration-none fw-semibold"
                     th:href="@{/tasks/{taskId}/todos/{id}(taskId=${task.id}, id=${t.id})}"
                     th:text="${t.title}">
                    Todo Titel
                  </a>

                  <div>
                    <small class="text-muted"
                           th:text="${t.description != null ? t.description : ''}"></small>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-header bg-body-tertiary">
            <strong>Kommentare</strong>
          </div>

          <div class="card-body">

            <form id="commentForm"
                  th:object="${commentCreate}"
                  th:action="@{/tasks/{taskId}/comments/add(taskId=${task.id})}"
                  method="post" class="mb-3">

              <div class="mb-2">
                <textarea class="form-control" rows="3" th:field="*{text}" placeholder="Kommentar schreiben..."></textarea>
              </div>

              <input type="hidden" th:field="*{notificationScope}" id="notificationScope"/>

              <button type="button" class="btn btn-sm btn-primary" id="commentPostBtn">
                Posten
              </button>
            </form>

            <div class="modal fade" id="commentNotifyModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Benachrichtigung senden?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
                  </div>

                  <div class="modal-body">
                    <div class="text-muted small">
                      Wer soll per E-Mail benachrichtigt werden?
                    </div>
                  </div>

                  <div class="modal-footer d-flex flex-wrap gap-2 justify-content-end">
                    <button type="button" class="btn btn-outline-secondary" data-scope="NONE">Niemand</button>
                    <button type="button" class="btn btn-outline-secondary" data-scope="OWNER">Owner</button>
                    <button type="button" class="btn btn-outline-secondary" data-scope="MANAGER">Manager</button>
                    <button type="button" class="btn btn-primary" data-scope="ALL">Alle</button>
                  </div>
                </div>
              </div>
            </div>

            <div th:if="${comments == null or comments.isEmpty()}" class="text-muted">
              Keine Kommentare vorhanden.
            </div>

            <div th:if="${comments != null and !comments.isEmpty()}" class="vstack gap-3">
              <div th:each="c : ${comments}" class="border rounded p-3 bg-body-tertiary">

                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold"
                         th:text="${c.createdByUser.lastName + ', ' + c.createdByUser.firstName}">
                      Mustermann, Max
                    </div>
                    <small class="text-muted"
                           th:text="${#temporals.format(c.createdAt, 'dd.MM.yyyy HH:mm')}"></small>
                  </div>

                  <div class="d-flex gap-2 flex-wrap justify-content-end">
                    <a th:if="${currentUserId == c.createdByUser.id}"
                       class="btn btn-sm btn-outline-secondary"
                       th:href="@{/tasks/{taskId}/comments/{id}(taskId=${task.id}, id=${c.id})}">
                      Bearbeiten
                    </a>

                    <form th:if="${currentUserId == c.createdByUser.id or canManageTasks}"
                          th:action="@{/tasks/{taskId}/comments/{id}/delete(taskId=${task.id}, id=${c.id})}"
                          method="post">
                      <button type="submit"
                              class="btn btn-sm btn-outline-danger"
                              onclick="return confirm('Kommentar wirklich löschen?');">
                        Löschen
                      </button>
                    </form>
                  </div>
                </div>

                <div class="mt-2" th:text="${c.text}">
                  Kommentartext...
                </div>

              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
            <strong>Zugewiesene Mitarbeiter</strong>
            <a th:if="${canManageTasks}"
               th:href="@{/tasks/{taskId}/assignments/add(taskId=${task.id})}"
               class="btn btn-sm btn-outline-primary">
              + Zuweisen
            </a>
          </div>

          <div class="card-body">
            <div th:if="${assignments == null or assignments.isEmpty()}" class="text-muted">
              Keine Mitarbeiter zugewiesen.
            </div>

            <div th:if="${assignments != null and !assignments.isEmpty()}" class="vstack gap-2">
              <div th:each="a : ${assignments}" class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <div class="fw-semibold"
                       th:text="${a.user.lastName + ', ' + a.user.firstName}">
                    Mustermann, Max
                  </div>
                  <small class="text-muted" th:text="${'Minuten: ' + a.minutesWorked}"></small>
                </div>

                <form th:if="${canManageTasks}"
                      th:action="@{/tasks/{taskId}/assignments/{userId}/delete(taskId=${task.id}, userId=${a.user.id})}"
                      method="post">
                  <button type="submit" class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Mitarbeiter wirklich entfernen?');">
                    Entfernen
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header bg-body-tertiary">
            <strong>Quick Info</strong>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <span class="text-muted">Todos</span>
              <span th:text="${todos != null ? todos.size() : 0}">0</span>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <span class="text-muted">Materialien</span>
              <span th:text="${materials != null ? materials.size() : 0}">0</span>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</main>

<div th:insert="~{fragments/footer :: siteFooter}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('commentForm');
    const openBtn = document.getElementById('commentPostBtn');
    const scopeInput = document.getElementById('notificationScope');
    const modalEl = document.getElementById('commentNotifyModal');
    const modal = new bootstrap.Modal(modalEl);

    openBtn.addEventListener('click', function () {
      modal.show();
    });

    modalEl.querySelectorAll('button[data-scope]').forEach(btn => {
      btn.addEventListener('click', function () {
        scopeInput.value = btn.getAttribute('data-scope');
        modal.hide();
        form.submit();
      });
    });
  });
</script>

</body>
</html>